<!DOCTYPE html>
<html>
<head>
<!--

*0. Pull up local storage - show in console.
1. API to get pull the 2min random value
3. Get back the number of seconds (TTL) for this to live

Gen ID
	1. Add in "sha256" JS library
	2. Add in "fingerprint" library
	3. Combine data - get # to console

Count Down Timer:
	1. Add in a count-down timer
	2. Add ability to refresh

Extend To 2nd/3rd site
	1. Add in menu - add ability to add 2nd/3rd - URL (add ID, pull data)

https://github.com/emn178/js-sha256

-->
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<!-- <link rel="canonical" href="https://weather-pwa-sample.firebaseapp.com/final/"> -->
	<base href="/2fa/">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>2FA App</title>
	<link rel="stylesheet" type="text/css" href="styles/inline.css?_ran_=v004">

	<!-- TODO add manifest here -->
	<!-- <link rel="manifest" href="/manifest.json"> -->

	<!-- Add to home screen for Safari on iOS -->
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-title" content="2FA Auth">
	<link rel="apple-touch-icon" href="images/icons/icon-152x152.png">
	<meta name="msapplication-TileImage" content="images/icons/icon-144x144.png">
	<meta name="msapplication-TileColor" content="#2F3BA2">
</head>
<body>

	<header class="header">
		<h1 class="header__title">2FA Auth v004</h1>
		<button id="butRefresh" class="headerButton" aria-label="Refresh"></button>
		<button id="butAdd" class="headerButton" aria-label="Add"></button>
	</header>

	<main class="main">
		<div class="card cardTemplate weather-forecast" hidden>
			<div class="city-key" hidden></div>
			<div class="card-last-updated" hidden></div>

			<div class="location" id="x2faURL"></div>
			<div class="description"></div>
			<div class="x2faValue" id="x2faValue"></div>
			<div class="countdown" id="x2faTTL"></div>
		</div>
	</main>

	<div class="dialog-container">
		<div class="dialog">
			<div class="dialog-title">Add two factor authenticated site</div>
			<div class="dialog-body">
				URL: <input id="siteUrl" name="siteUrl">  <br>
				ID: <input id="siteID" name="siteID">  <br>
			</div>
			<div class="dialog-buttons">
				<button id="butAddCity" class="button">Add</button>
				<button id="butAddCancel" class="button">Cancel</button>
			</div>
		</div>
	</div>

	<div class="loader">
		<svg viewBox="0 0 32 32" width="32" height="32">
			<circle id="spinner" cx="16" cy="16" r="14" fill="none"></circle>
		</svg>
	</div>

	<script src="/js/jquery-3.3.1.js"></script>
	<script src="/js/sha256.js"></script>
	<!-- Uncomment the line below when ready to test with fake data -->
	<script src="js/app.js?_ran_=v004" async></script>

<script>
var URL_Random;
// {"status":"success","value":"5b2b130c9689ba17b9967da6668e80f18dfb6eaa4c49c315eaa091ea93522e41","ttl":104,"ep":12908997}
// URL_Random = 'http://127.0.0.1:9019/Ran/RandomValue';	// xyzzy - fix 
URL_Random = 'http://www.2c-why.com/Ran/RandomValue';	// BLOCKED by CORS request

var ls_s = localStorage.getItem('2fa_hash');
var ls = JSON.parse ( ls_s );
console.log ( 'ls=', ls );

var loginURL = "http://127.0.0.1:9019";
var aa = ls[loginURL].hash;
var bb = ls[loginURL].fp; // should regenerate this using FP code. xyzzy.

$ = jQuery;

console.log ( "Before AJAX" );

var distance = 120;

// Update the count down every 1 second
var x = setInterval(function() {

	distance--;
	$("#x2faTTL").text(distance+" sec");

	// If the count down is finished, write some text 
	if (distance <= 0) {
		clearInterval(x);
		$("#x2faValue").text("");
		$("#x2faTTL").text("");
		// document.getElementById("demo").innerHTML = "EXPIRED";
	}
}, 1000);

$.ajax({
	type: 'POST',
	url: URL_Random,
	data: {},
	dataType: "jsonp",
	success: function (data) {
		// data = JSON.parse(data);		// If it is returned text - the will not be parsed.
		console.log ( 'RandomValue=', data );	 // already parsed.
		if ( data.status == "success" ) {
			var cc = data.value;
			var ss = aa+":"+bb+":"+cc;
			console.log('(Before sha256 String) ss=', ss);
			var val0 = sha256(ss);
			console.log('(After sha256 Value - the Hash) val0=', val0);
			//	val0 := HashStrings.Sha256(fmt.Sprintf("%s:%s:%s", user_hash, fp, current2MinHash))

			//	val1 := fmt.Sprintf("%x", val0)

			var val2 = val0.substr(val0.length - 6); 
			console.log('val2=', val2);
			//	val2 := val1[len(val1)-6:]

			//	val, err := strconv.ParseInt(val2, 16, 64)
			//	if err != nil {
			//		fmt.Fprintf(www, `{"status":"failed","msg":"Failed to parse[%s] as base 16 int Error: %s","LineFile":%q}`,
			//			val2, err, godebug.LF())
			//		return
			//	}
			var val = parseInt(val2, 16);
			console.log ( "val=", val );

			val = val % 1000000;
			console.log ( "val=", val );
			//	val = val % 1000000

			var str = "" + val;
			var pad = "000000";
			var val_s = pad.substring(0, pad.length - str.length) + str
			//	val_s := fmt.Sprintf("%06d", val) // list = append(list, fmt.Sprintf("%06d", val))

			console.log ( "final value", val_s );
			//	fmt.Fprintf(www, `{"status":"success","val":%q,"ttl":%d}`, val_s, ttlLeft)
			
			$("#x2faURL").text(loginURL);
			$("#x2faValue").text(val_s);
			distance = data.ttl;
			$("#x2faTTL").text(distance+" sec");
		}
		if ( data.status && data.status != "success" ) {
			alert ( data.msg );
		}
		// $("#output").text( JSON.stringify(data, null, 4) );
	},
	error: function(resp) {
		console.log("error=",resp);
		alert("got error status="+resp.status+" "+resp.statusText);
	}
});

// var ss = aa+":"+bb+":"+cc;

// URL to pull to get 2min hash:
// jQuery to make "get" call

// var vv = sha256(ss);
// console.log(vv);

</script>

</body>
</html>
